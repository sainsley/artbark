<link href='http://fonts.googleapis.com/css?family=Cabin+Sketch' rel='stylesheet' type='text/css'>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ArtBark</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="external_js/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
		<style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
		<link href="external_js/fontawesome/css/font-awesome.css" rel="stylesheet">
    <link href="external_js/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" style="padding-top: 20px; font-size: 48px;">ArtBark</a>
          <div class="nav-collapse collapse">
            <p id="welcomeMsg" class="navbar-text pull-right" style="line-height:1.2; text-align:right; padding-top:4px">
               Welcome, <a id="linkUserEmail" href="login.html" class="navbar-link">Guest</a><br />
               Session ID: <a id="linkSession" href="login.html" class="navbar-link">N/A</a>
            </p>
            
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>
		
		<div id="alert-holder"></div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span8">
          <div id="image-holder" class="hero-unit">
						<div id="title-bar">
							<div id="by-line" class="span5">
								<h2 id="title">"Marilyn Diptych"</h2>
								<p id="author">Andy</p>
							</div>
							<div id="rating" class="span5 offset2">
								<p id="ratingText"></p>
								
								<div id="star-container-1" class="starContainer"><img id="star-1" class="star" src="graphics/star.png" data-idx="1"></img></div>
								<div id="star-container-2" class="starContainer"><img id="star-2" class="star" src="graphics/star.png" data-idx="2"></img></div>
								<div id="star-container-3" class="starContainer"><img id="star-3" class="star" src="graphics/star.png" data-idx="3"></img></div>
								<div id="star-container-4" class="starContainer"><img id="star-4" class="star" src="graphics/star.png" data-idx="4"></img></div>
								<div id="star-container-5" class="starContainer"><img id="star-5" class="star" src="graphics/star.png" data-idx="5"></img></div>
							</div>
						</div>
            <img id="art" src="graphics/warhol.jpg"></img>
			<!--<div class="btn-magnify"><button id="btn-magnify" type="button" class="btn btn-primary" data-toggle="button"><i id="icon-magnify" class="icon-zoom-in"></i></button></div> -->
						<textarea style='position: absolute; display: none; resize: none;' id='edit-annotation-entry'  class='comment well'></textarea>
						<div id="anotate" class="popover fade right in" style="display: block;">
							<div class="arrow"></div>
							<h3 class="popover-title">Annotate this work<button class="btn btn-large close-annotation close"><i class="icon-remove-circle"></i></button></h3>
							<div class="popover-content">
								<div class="annotation insertTags">
									Tag:
								</div>
								<textarea id="annotation-entry" class="comment-box span12" rows="5"></textarea>
								<button class="annotation post btn btn-info span12" style="margin-left: 0;" data-entry="#annotation-entry">Post</button>
							</div>
							<i id='temp-pin' class='icon-map-marker pin' style="color: #ebebeb; display: none; opacity:0.9;"></i>
						</div>
          </div>
        </div><!--/span-->
        <div class="span4">
          <div id="comments-holder" class="well sidebar-nav">
						<h3 class="nav-header" style="font-size: 16px;">Comment</h3>
            <ul id="comments"class="nav nav-list">
				<!--<li class="comment well tag-happy group-friends userType-artist">This looks #happy! -- your friend</li>
				<li class="comment well tag-sad group-mentors userType-artist">I think this looks #sad -- your mentor #2.</li>
				<li class="comment well tag-pastoral group-mentors userType-artist">Looks very #pastoral to me -- your mentor.</li>-->
            </ul>
						<div class="comment insertTags userType-commenter" style="	margin-left: 15px;">
							<span style="font-size: 20; font-weight: 200; vertical-align: top;">Tag:</span>
						</div>
						<textarea id="main-entry" class="comment-box userType-commenter" rows="5"></textarea>
						<div>
							<button class="comment post btn btn-info userType-commenter" data-entry="#main-entry">Post</button>
						</div>
					</div><!--/.well -->

			<div id="tags-holder" class="well sidebar-nav userType-artist">
				<h3 class="nav-header" style="font-size: 16px;">Filter by tag</h3>
				<div class="btn-group nav-content" id="btn-group-tags" data-toggle="buttons-checkbox">
				  <!--<button type="button" class="btn btn-primary">Tag1</button>
				  <button type="button" class="btn btn-primary">Tag2</button>
				  <button type="button" class="btn btn-primary">Tag3</button> -->
				</div>
			</div>

		  	<div id="groups-holder" class="well sidebar-nav userType-artist">
				<h3 class="nav-header" style="font-size: 16px;">Filter by group</h3>

				<div class="btn-group nav-content" id="btn-group-groups" data-toggle="buttons-checkbox">
				  <!--<button type="button" class="btn btn-primary">Group1</button>
				  <button type="button" class="btn btn-primary">Group2</button>
				  <button type="button" class="btn btn-primary">Group3</button> -->
				</div>
			</div>
        </div><!--/span-->
      </div><!--/row-->

      <hr>

      <footer>
        <p>&copy; 6.813 User Interface Design : GR6</p>
      </footer>

    </div><!--/.fluid-container-->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="external_js/jquery.js"></script>
		<script src="external_js/jquery-ui-1.10.2.custom.min.js"></script>
    <script src="external_js/bootstrap/js/bootstrap.js"></script>
	<script src="userData.js"></script>
		<script>
			// for keeping track of temp pen cursor 
			var pinX, pinY;
			var current_annotation;
			
			// Server data section =================================
			$(function(){ getUserData(initUserData) })
			
			function initUserData(data){
				artistEmail = $.getUrlVar('artistEmail')
				userData = data
				
				// show the art the that artist uploaded
				$('#art').attr('src', './uploads/' + data[artistEmail].artFile)
				
				$('#author').text('by ' + artistEmail)
				$('#title').text('"' + data[artistEmail].title + '"')
				
				artistDefinedTags = data[artistEmail].tags
				artistDefinedGroups = []
				for (var i=0;i<userData[artistEmail].groups.public.length;i++)
                {
                    artistDefinedGroups.push(userData[artistEmail].groups.public[i])
                }

                for (var i=0;i<userData[artistEmail].groups.private.length;i++)
                {
                    artistDefinedGroups.push(userData[artistEmail].groups.private[i])
                }

				
				//artistDefinedGroups = something
				initFilters()
				
				//transient_delete_comment = delete_comment 
				delete_comment = function(id) {
					$.ajax({
						type: 'POST',
						dataType: 'text',
						url: '/comment-delete',
						data: JSON.stringify({
							artist: artistEmail,
							id: id,
							author: userEmail,
						})
					})
					console.log("delete comment "+id)
					transient_delete_comment(id)
				}
				
				transient_add_comment = add_comment
				add_comment = function(comment, id, pinid){
					var type = "comment";
					var pin_x = -1;
					var pin_y = -1;
					if (pinid > -1) {
						type = "pin";
						var pin_id = "#pin-"+pinid;
						pin_x = $(pin_id).offset().left;
						pin_y = $(pin_id).offset().top;
					
					}
					$.ajax({
						type: 'POST',
						dataType: 'text',
						url: '/comment',
						data: JSON.stringify({
							type: type,
							artist: artistEmail,
							commenter: userEmail,
							comment_text: comment,
							pin: pinid,
							pinX: pin_x,
							pinY: pin_y,
							id: id
						})
					})
					
					transient_add_comment(comment, id, pinid)
				}
				
				// transient definitions are just for things that happen on the page.  non-transient functions send 
				// data to the server
				
				// on page load, add comments stored on the server
				
				for(var comment in data[artistEmail].comments){
					console.log('---> auto-adding saved comment', comment)
					comment = data[artistEmail].comments[comment]
					if (!comment) continue;
					transient_add_comment(comment.text + ' -- ' + comment.author, comment.id, comment.pin)
					if(comment.type == 'pin'){
						add_pin(comment.pin, comment.pinX, comment.pinY);
						add_annotation(comment.pinX, comment.pinY, comment.text, comment.pin);
						$('#annotation-'+comment.pin).data('comment-id', comment.id);
					} 
					/*else if(comment.type == 'pin'){
						if (comment.pin > -1) {
							add_pin(comment.pin, comment.pinX, comment.pinY);
							console.log("ADD Pin: "+comment.pinX+" "+comment.pinY);
							transient_add_comment_pin(comment.pin, comment.id)
							add_annotation(comment.pinX, comment.pinY, comment.text, comment.pin);
							$('#annotation-'+comment.pin).data('comment-id', comment.id);
						}
						
					}*/
				}
			}
			// =====================================================
		
			$.extend({
				getUrlVars : function() {
					var vars = [], hash;
					var hashes = window.location.href.slice(
							window.location.href.indexOf('?') + 1).split('&');
					for ( var i = 0; i < hashes.length; i++) {
						hash = hashes[i].split('=');
						vars.push(hash[0]);
						vars[hash[0]] = hash[1];
					}
					return vars;
				},
				getUrlVar : function(name) {
					return $.getUrlVars()[name];
				}
			});
	
			function getSettingsFromUrl(){
				if($.getUrlVar('tags')) 
				{
					artistDefinedTags = ($.getUrlVar('tags')).split(',');
					//trialsPerUser = (parseInt($.getUrlVar('trialsPerUser')));
					
				}

				if($.getUrlVar('groups')) 
				{
					artistDefinedGroups = ($.getUrlVar('groups')).split(',');
					//trialsPerUser = (parseInt($.getUrlVar('trialsPerUser')));
				}

				if($.getUrlVar('userType')) 
				{
					userType = $.getUrlVar('userType');
					//trialsPerUser = (parseInt($.getUrlVar('trialsPerUser')));
					
				}

				if($.getUrlVar('userEmail')) 
				{
					userEmail = $.getUrlVar('userEmail');
					$("#linkUserEmail")[0].innerHTML = userEmail;

					//trialsPerUser = (parseInt($.getUrlVar('trialsPerUser')));
					
				}

				if($.getUrlVar('sessionId')) 
				{
					sessionId = $.getUrlVar('sessionId');
					$("#linkSession")[0].innerHTML = sessionId;
					//trialsPerUser = (parseInt($.getUrlVar('trialsPerUser')));
					
				}
			};
			
			var artistDefinedTags = new Array("happy","pastoral","sad");
			var artistDefinedGroups = new Array("Mentors","Friends");
			var userType = "artist";

			var userEmail;
			var artistEmail;
			var sessionId;
			var userData;

			var filters = new Object();
			

			var selectedAnnotation;
			var expandedAnnotation;
			
			var comment_count = 0;
			
			
			add_pin_icon = function(pin, id) {
				var comment = "#show-" + id;
				var pin_icon = "<i class='icon-map-marker pin-comment-unselected' id='unpinned-"+id+"' data-id='"+id+"' style='margin-right: 10px'></i>";
				// there is a pin
				if (pin != -1) {
					pin_icon = "<i class='icon-map-marker pin-comment' style='margin-right: 10px'></i>";
					// add comment id
					$('#annotation-'+pin).data('comment-id', id);
				}
				$(comment).prepend(pin_icon);
			 	// make comment pin draggable
				if (pin == -1) {
					// make draggable if no pin exists
					var pin_obj = $("#unpinned-"+id);
					console.log(pin_obj);
					pin_obj.draggable({
						revert : true
					});
				}
			}
			
			temp_delete_comment = function(id) {
				//var id = $(delete_btn).data("id");
				var comment = '#comment-'+id;
				var pin = $(comment).data("pin");
				// there is a pin
				if (pin != -1) {
					pin = '#pin-'+pin;
					$(pin).hide();
				} else {
					deleted_pin = -1;
				}
				$(comment).hide();
				var comment_text =  $('#show-'+id).text();
				show_delete_alert(id, comment_text, comment, pin);
			}
			
			show_delete_alert = function(id, comment_text, comment, pin) {
				var alertHtml = '<div id="delete-alert-'+id+'" class="alert" style="display: none;"> <button type="button" class="close" data-dismiss="alert" id="perm-delete-'+id+'">&times;</button> <strong>Comment Deleted</strong> '+comment_text+' <a id="undo-'+id+'">Undo? </a></div>';
				// strange duplicate bug i dont have time to fix
				if (!$('#delete-alert-'+id)[0]) {
					var alert = $(alertHtml);
					alert.appendTo('#alert-holder');
					$("#undo-"+id).data('pin', pin);
					$("#undo-"+id).data('comment', comment);
					$("#undo-"+id).click(function() {
						var deleted_comment = $(this).data('comment');
						var deleted_pin = $(this).data('pin');
						$(deleted_comment).show();
						if (deleted_pin != -1) {
							$(deleted_pin).show();
						}
						alert.remove();
					});
					$("#perm-delete-"+id).click(function() {
						delete_comment(id);
					});
					
					// auto-remove after a while
					window.setTimeout(function() {
						alert.fadeOut('slow'); 
						//alert.alert('close'); 
						delete_comment(id);
					}, 10000);
					alert.show();
				}
			}
			
			edit_comment = function(edit_btn) {
				var comment = '#show-'+$(edit_btn).data("id");
				var current = $(comment).text();
				$(comment).hide();
				var edit = '#edit-'+$(edit_btn).data("id");
				var entry = '#entry-'+$(edit_btn).data("id");
				$(entry).val(current);
				$(edit).show();
			}
			
			save_comment = function(save_btn) {
				var edit = '#edit-'+$(save_btn).data("id");
				var entry = '#entry-'+$(save_btn).data("id");
				var current = $(entry).val();
				//$(comment).text(current);
				var id = $(save_btn).data("id");
				update_comment(id, current);
				$(edit).hide();
			}
			
			update_comment = function(id, text) {
				var comment = '#show-'+id;
				var toolbar = get_tool_panel(id); 
				$(comment).show();
				$(comment).text(text);
				$(comment).append(toolbar);
				configure_tools();
				// update pin
				var pin = $('#comment-'+id).data("pin");
				// there is a pin
				if (pin != -1) {
					$('#annotation-'+pin).text(text);
				}
				add_pin_icon(pin, id);
			}
			
			update_current_annotation = function(text) {
				var id = current_annotation.data("comment-id");
				current_annotation.text(text);
				update_comment(id, text);
				current_annotation.show();
				$("#edit-annotation-entry").hide();
			}
			
			get_tool_panel = function(comment_id) {
				var edit_button = '<button class="edit menu-btn close" data-id="'+comment_id+'"><i class="icon-pencil"></i></button>';
				var delete_button = '<button class="delete menu-btn close" data-id="'+comment_id+'"><i class="icon-remove"></i></button>';
				return delete_button+edit_button;
			}
			
			configure_tools = function() {
			  $(".delete").click(function (event) {
					var id = $(this).data("id");
					temp_delete_comment(id);
			   });
 			  $(".edit").click(function (event) {
 					edit_comment(this);
 			   });
			}
			
			link_annotations = function() {
				$(".comment-pin").mouseover(function() {
					var pin = $(this).data("pin");
					var pinid = '#pin-'+pin;
					$(pinid).css('opacity', 1.0); 
					});
				$(".comment-pin").mouseout(function() {
					var pin = $(this).data("pin");
					var pinid = '#pin-'+pin;
					$(pinid).css('opacity', 0.7); 
					});
			}
			
			add_comment = function(body, id, pin_id) {
				// assign id to comment and make data entry for delete_button
				// also assign pin id to comment if applicable
				var id_string = '"comment-'+id+'"';
				var data_pin = 'data-pin="'+pin_id+'"';
				// construct show panel
				var toolbar = get_tool_panel(id); 
				var show_panel = '<div id="show-'+id+'">'+body+toolbar+'</div>'
				// construct edit panel
				var entry_panel = '<input id="entry-'+id+'" type="text"></input>'
				var save_button = '<button class="save menu-btn close" data-id="'+id+'"><i class="icon-ok"></i></button>';
				var edit_panel = '<div id="edit-'+id+'" style="display: none;">'+entry_panel+save_button+'</div>'
				
				var tags = new Array;

				$.each( filters, function( key, value ) {
					var tagName;

					if(key.indexOf("tag-") == 0)
					{
						tagName = key.substring("tag-".length);
						if(body.indexOf("#"+tagName)>-1)
						{
							tags.push(tagName);
						}
					}
				});

				console.log(tags);
				var comment_class = '"comment well';
				if (pin_id > -1) {
					comment_class += ' comment-pin';
				}

				if(body.indexOf("-- your mentor")>-1)
				{
					comment_class += ' group-mentors';
				}
				else if(body.indexOf("-- your friend")>-1)
				{
					comment_class += ' group-friends';
				}


				var list_item = '<li class='+comment_class;

				for(var i=0;i<tags.length;i++)
				{
					list_item += " tag-" + tags[i];
				}
				
				if (userType=="artist") {
					list_item += '" ' +  data_pin+'id='+id_string+' data-id="'+id+'">'+body+'</li>';
				} else {
					list_item += '" ' +  data_pin+'id='+id_string+' data-id="'+id+'">'+show_panel+edit_panel+'</li>';
				}

				$("#comments").append(list_item);
			  $(".save").click(function (event) {
					save_comment(this);
			   });
				
				add_pin_icon(pin_id, id);
				configure_tools();
				link_annotations();
				comment_count = Math.max(comment_count+1, id+1);
			}

			add_button_tag = function(tagName) {
				var tagId = "tag-"+tagName; 
				var newButton = '<button type="button" class="btn btn-primary btn-filter" id="' + tagId + '">#' + tagName + '</button>';
				$("#btn-group-tags").append(newButton);
				console.log($("#"+tagId));
				$("#"+tagId)[0].addEventListener("click",onClickFilterButton,false);
				$("#"+tagId)[0].className += " active";

				var newInsertTagButton = '<button type="button" class="well btn-insert-tag">#' + tagName + '</button>';

/*()				for(var i=0;i<$(".insertTags").length;i++)
				{
					$(".insertTags")[i].append(newInsertTagButton);
				}*/
				$(".insertTags").append(newInsertTagButton);

				filters[tagId] = 1;
				
			}

			add_group_tag = function(groupName) {
				var groupId = "group-" + groupName.toLowerCase();
				var newButton = '<button type="button" class="btn btn-primary btn-filter" id="' + groupId + '">' + groupName + '</button>';
				$("#btn-group-groups").append(newButton);
				$("#"+groupId)[0].addEventListener("click",onClickFilterButton,false);
				$("#"+groupId)[0].className += " active";
				filters[groupId] = 1;
			}

			applyfilters = function(filterIds)
			{
				console.log("applying filters");
				console.log(filters)
				var comments = $("li.comment");

				console.log(comments);

				if(comments.length>0)
				{
					for (var i=0;i<comments.length;i++)
					{
						var isVisible = true;
						var classes = comments[i].className.split(" ");
						console.log("comment: " + comments[i])
						for(var j=0;j<classes.length;j++)
						{
							console.log(classes)
							if(classes[j].indexOf("tag-")==0 || classes[j].indexOf("group-")==0)
							{
								isVisible = isVisible & filters[classes[j]];
								console.log(isVisible)
							}

						}

						
						var pin = $(comments[i]).data("pin");
						if(isVisible)
						{
							comments[i].style.display = "block";

							if(pin != -1)
							{
								var pinid = '#pin-'+pin;
								$(pinid).show();
							}
						}
						else
						{
							comments[i].style.display = "none";

							if(pin != -1)
							{
								var pinid = '#pin-'+pin;
								$(pinid).hide();
							}
						}
					}
				}
			}

			initFilters = function()
			{
				// Add filtering options for tags and groups
				for(var i=0;i<artistDefinedTags.length;i++)
				{
					//var tagName = artistDefinedTags[i];
					//
					add_button_tag(artistDefinedTags[i]);
					
				}

				for(var i=0;i<artistDefinedGroups.length;i++)
				{
					add_group_tag(artistDefinedGroups[i]);
				}
			}

			onClickFilterButton = function(event)
			{
				console.log($(this)[0].className);
				console.log(event);

				var filterName = $(this)[0].id;

				// If button is raised (not active)
				if(filters[filterName]==0)
				{
					filters[filterName] = 1;
					console.log("pressed")
					//filters.splice(filters.indexOf($(this)[0].id),1);
					//filters[filterName] = 0;
				}
				else
				{
					console.log("unpressed")
					//filters.push($(this)[0].id);
					filters[filterName] = 0;
				}
				console.log(filters);
				applyfilters();
			}
			
			/*
			$("#btn-magnify").click(function(event) {
				
			});*/

			avgRating = 3.3;
			setRatingText = function()
			{
				var ratingText;
				if(userType == "artist")
				{
					ratingText = "Average rating: " + String(avgRating);
				}
				else
				{
					ratingText = "Rate this piece below...";
				}

				$("#ratingText")[0].innerHTML = ratingText;
			}
			
		 	$(document).ready(function() {
				$("#edit-annotation-entry").keypress(function(event) {
				  if ( event.which == 13 || event.keyCode == 13 ) {
						console.log("ENTER: "+$(this).val());
				    update_current_annotation($(this).val());
				  }
				});
				
	 			// Disables drag behavior of img so that you can't pick it up
				$('#art').on('dragstart', function(event) { event.preventDefault(); });
				// art handles pin drops
				$("#art").droppable( {
					hoverClass: 'droppable',
					drop: handlePinDrop
				} );
				
				$('.nav-tabs').button();
				getSettingsFromUrl();
				

				setRatingText();

				console.log("usertype="+userType);
				// Ghetto session control
				if(userType == "artist")
				{
					if($(".userType-commenter").length > 0)
					{
						for(var i=0;i<$(".userType-commenter").length;i++)
						{
							$(".userType-commenter")[i].style.display = "none";
						}
					}
				}	
				else
				{
					if($(".userType-artist").length>0)
					{
						for(var i=0;i<$(".userType-artist").length;i++)
						{
							$(".userType-artist")[i].style.display = "none";
						}
					}
				}
			
				$('#anotate').hide();
				
				var pin_count = 0;
				// drag-to-convert
				function convertComment(id, x, y) {
					pinX = x-25/2;
					pinY = y-30;
					// add pin
					add_pin(pin_count, pinX, pinY);
					var comment = $('#comment-'+id);
					comment.addClass("comment-pin");
					var pin_id = pin_count-1;
					comment.data("pin", pin_id);
					// add annotation
					var comment_text =  $('#show-'+id).text();
					add_annotation(pinX, pinY, comment_text, pin_id);
					add_pin_icon(pin_id, id);
					link_annotations();
					// add pin indicator
				}
			
				// See if dropped checker is in valid pos
				function handlePinDrop ( event, ui ) {
					if (!ui.draggable.data('id')) return;
					console.log(ui.draggable.data('id')+" "+event.pageX+" "+event.pageY);
					ui.draggable.draggable( 'option', 'revert', false );
					convertComment(ui.draggable.data('id'), event.pageX, event.pageY);
					ui.draggable.remove();
				}
				
				//
				// Ratings feedback
				//
				
				$(".star").mouseover(function(event) {
					if(userType=='artist') {
						return;
					}
					var id = $(this).data("idx");
					var rollover = "graphics/star-fill.png"
					for (var i = 1; i <= id; ++i) {
						$("#star-"+i).attr("src", rollover);
					}
				});
				
				$(".star").mouseout(function(event) {
					if(userType=='artist') {
						return;
					}
					var id = $(this).data("idx");
					var original = "graphics/star.png"
					for (var i = 1; i <= id; ++i) {
						if($("#star-"+i).css("opacity") < 1.0) {
							$("#star-"+i).attr("src", original);
						}
					}
				});
				
				$(".star").click(function(event) {
					if(userType=='artist') {
						return;
					}
					var id = $(this).data("idx");
					var filled = "graphics/star-fill.png"
					var empty = "graphics/star.png"
					for (var i = 1; i <= id; ++i) {
						$("#star-"+i).attr("src", filled);
						$("#star-"+i).css("opacity", 1.0);
					}
					for (var i = id+1; i <= 5; ++i) {
						$("#star-"+i).attr("src", empty);
						$("#star-"+i).css("opacity", 0.6);
					}
				});
				
				$(".comment.post").click(function(event) {
					var entry = $(this).data("entry");
					console.log($(entry).val());
					if ($(entry).val()) {
						// Not associated with pin
						add_comment($(entry).val(), comment_count, -1);
						$(entry).val('');
					}
				});
				
				$(".annotation.post").click(function(event) {
					var entry = $(this).data("entry");
					if ($(entry).val()) {
						$('#temp-pin').hide();
						add_pin(pin_count, pinX, pinY);
						var pin = $('#pin-' + String(pin_count-1));
						console.log($('#pin-' + String(pin_count-1)));
						console.log($('#anotate'));
					
						add_annotation(pin[0].offsetLeft, pin[0].offsetTop,$(entry).val(),pin_count-1);
					
						add_comment($(entry).val(), comment_count, pin_count-1);
						$(entry).val('');
						$('#anotate').hide();
					}
				});
				
				$(".close-annotation").click(function(event) { 
			 		$('#anotate').hide();
					$("#annotation-entry").val('');
			 	});
				
				$("#art").click(function(event) {
					if(userType=='artist') {
						return;
					}
					
					if(expandedAnnotation!=null) {
						expandedAnnotation[0].children[0].style.display = 'none';
					}
						
					$('#anotate').show();
					var offset = $('#anotate').height()/2;
					$('#anotate').offset({ top: event.pageY-offset+6, left: event.pageX+12});
					pinX = event.pageX-25/2;
					pinY = event.pageY-30;
					$('#temp-pin').show();
					$('#temp-pin').position({ top: 0, left: 0});
					$('#temp-pin').offset({ top: pinY, left: pinX});

				});

				$(".btn-insert-tag").click(function(event)
				{
					
					if(($(this)[0].parentElement.className).indexOf("annotation")>-1)
					{
						var entryArea = $("#annotation-entry");
						
					}
					else if(($(this)[0].parentElement.className).indexOf("comment")>-1)
					{
						var entryArea = $("#main-entry");
					}
					console.log("writing to textarea");
					console.log(entryArea);
					entryArea.val(entryArea.val() + $(this)[0].innerHTML);
				});

				
				function onMouseEnterAnnotation(event)
				{
	
					if ($("#edit-annotation-entry").is(":visible")) return;
					$(this)[0].children[0].style.display = 'block';
					$(this).css('opacity', 1.0); 
					var annotate = $(this).children()[0];
					var comment_id = $(annotate).data("comment-id");
					$("#comment-"+comment_id).addClass("glow");
				}
				
				function onMouseLeaveAnnotation(event)
				{
					if ($("#edit-annotation-entry").is(":visible")) return;
					if (!$(this).hasClass("preserve")) {
						$(this)[0].children[0].style.display = 'none';
						$(this).css('opacity', 0.7);
						var annotate = $(this).children()[0];
						var comment_id = $(annotate).data("comment-id");
						$("#comment-"+comment_id).removeClass("glow");
					}
					
				}
				
				add_pin = function(id, pin_x, pin_y) {
					
					var pin_id = "pin-"+id;
					var pin = $("<i id='"+pin_id+"' class='icon-map-marker pin'></i>");
					pin.appendTo('#image-holder');
					//addEvent(link, 'click', function () {alert('Hi'); });
					//$('body').append(pin);
					//$('#image-holder').append(pin);
					pin.offset({ top: pin_y, left: pin_x});
					console.log($('#'+pin_id)+" "+pin[0]);
					pin.draggable({
						cursor: 'move',
						containment: '#art'
					})
					//$('#div'+pin_id).offset({ top: event.pageY-30, left: event.pageX-25/2});
					pin[0].addEventListener("mouseover", onMouseEnterAnnotation, false);
					pin[0].addEventListener("mouseout", onMouseLeaveAnnotation, false);
					if (userType != 'artist') {
						pin.css('cursor', 'move');
					}
					//$('#'+pin_id)[0].className += "pin";
					pin_count++;
				}
				
				add_annotation = function(x,y, body, pin_id_num) {
					
					var annotationBox = "<div style='position: absolute' id='annotation-" + pin_id_num + "' class='comment well'>"+body+"</div>";
					$('#pin-' + pin_id_num).append(annotationBox);
					console.log("appending to pin");
					//console.log($("#pin-"+pin_id_num));
					
					//$("#comment-"+pin_id_num).offset({ top: event.pageY-30, left: event.pageX-25/2});
					$("#annotation-"+pin_id_num)[0].style.display = 'none';
					$("#annotation-"+pin_id_num)[0].addEventListener("click", onClickAnnotation, false);
				}
				
				function onClickAnnotation(event)
				{
					if(userType=='artist') { return; }
					/*if (!$(this).hasClass("preserve")) {
						$(this).addClass("preserve")
					} else {
						$(this).removeClass("preserve")
					}*/
					//$('#anotate').offset({ top: event.pageY-offset, left: event.pageX+6});
					current_annotation = $(this);
					console.log($(this));
					var entry = $("#edit-annotation-entry");
					entry.offset($(this).offset());
					entry.width($(this).width());
					entry.height($(this).height());
					entry.show();
					entry.val($(this).text());
					console.log("EDIT")
					$(this).hide();
					entry.focus();
					var caretPos = $(this).text().length
					entry[0].setSelectionRange(caretPos, caretPos);
				}


				
				// harcode for artist
				if(userType=='artist') {
					var fullStars = Math.floor(avgRating);
					console.log("full stars = " + fullStars)
					var fractionStar = avgRating - fullStars;
					for (var id = 1; id <= Math.ceil(avgRating); id++) {
						var rollover = "graphics/star-fill.png"
						$("#star-"+id).attr("src", rollover);
						$("#star-"+id).css("opacity", 1.0);
					}

					var starHider = "<div class='star-hider' style='width:" + 50*(1-fractionStar) +"px'></div>"
					$("#star-container-"+(fullStars+1)).append(starHider);
					//$("#star-container-"+(fullStars+1)).css("width",50*fractionStar);
					
				
					// hardcode annotations
					for (i = 0; i < 4; i++) {
						break // --------------------> kyle has disabled this hardcoding with this line
						var entry = "";
						if (i == 0) {
							pinX = 500;
							pinY = 700;
							entry = "love it! -- your friend";
						} 
						if (i == 1) {
							pinX = 620;
							pinY = 550;
							entry = "needs work -- your mentor";
						}
						if (i == 2) {
							pinX = 480;
							pinY = 300;
							entry = "nice color -- your mentor";
						}
						if (i == 3) {
							pinX = 200;
							pinY = 450;
							entry = "this one is my fav -- your friend";
						}
						add_pin(pin_count, pinX, pinY);
						var pin = $('#pin-' + String(pin_count-1));
						pin.draggable( 'disable' );
						console.log($('#pin-' + String(pin_count-1)));
						console.log($('#anotate'));
				
						transient_add_annotation(pin[0].offsetLeft, pin[0].offsetTop, entry,pin_count-1);
						transient_add_comment(entry, comment_count, pin_count-1);
						$('#anotate').hide();
					}	
					// hide crosshair on art for artists
					if(userType=='artist') {
						$("#art").css('cursor', 'auto');
					}
					
				}
		 	});
		</script>
  </body>
</html>
